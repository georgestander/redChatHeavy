{"version":3,"file":"chat-providers-siAwJkwV.js","sources":["../../../lib/create-anonymous-session.ts","../../../components/anonymous-session-init.tsx","../../../app/(chat)/chat-providers.tsx"],"sourcesContent":["import { ANONYMOUS_LIMITS, type AnonymousSession } from \"./types/anonymous\";\nimport { generateUUID } from \"./utils\";\n\nexport function createAnonymousSession(): AnonymousSession {\n  return {\n    id: generateUUID(),\n    remainingCredits: ANONYMOUS_LIMITS.CREDITS,\n    createdAt: new Date(),\n  };\n}\n","\"use client\";\n\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { useEffect } from \"react\";\nimport {\n  clearAnonymousSession,\n  getAnonymousSession,\n  setAnonymousSession,\n} from \"@/lib/anonymous-session-client\";\nimport { createAnonymousSession } from \"@/lib/create-anonymous-session\";\nimport { creditsKeys } from \"@/lib/query-keys\";\nimport type { AnonymousSession } from \"@/lib/types/anonymous\";\nimport { useSession } from \"@/providers/session-provider\";\n\n// Schema validation function\nfunction isValidAnonymousSession(obj: any): obj is AnonymousSession {\n  return (\n    obj &&\n    typeof obj === \"object\" &&\n    typeof obj.id === \"string\" &&\n    typeof obj.remainingCredits === \"number\" &&\n    (obj.createdAt instanceof Date || typeof obj.createdAt === \"string\")\n  );\n}\n\nexport function AnonymousSessionInit() {\n  const { data: session, isPending } = useSession();\n  const queryClient = useQueryClient();\n\n  useEffect(() => {\n    // Only initialize for non-authenticated users after session is loaded\n    if (isPending) {\n      return;\n    }\n    if (session?.user) {\n      return;\n    }\n\n    // Get raw session data and validate/migrate\n    const existingSession = getAnonymousSession();\n\n    if (existingSession) {\n      // Validate the existing session schema\n      if (!isValidAnonymousSession(existingSession)) {\n        console.warn(\n          \"Invalid session schema detected during init, clearing and creating new session\"\n        );\n        clearAnonymousSession();\n        const newSession = createAnonymousSession();\n        setAnonymousSession(newSession);\n        // Ensure UI refetches credits after creating a valid anonymous session\n        queryClient.invalidateQueries({\n          queryKey: creditsKeys.available,\n        });\n        return;\n      }\n    } else {\n      // Create new session if none exists\n      const newSession = createAnonymousSession();\n      setAnonymousSession(newSession);\n      // Ensure UI refetches credits after first-time session creation\n      queryClient.invalidateQueries({\n        queryKey: creditsKeys.available,\n      });\n    }\n  }, [session, isPending, queryClient]);\n\n  return null; // This component doesn't render anything\n}\n","\"use client\";\n\nimport { AnonymousSessionInit } from \"@/components/anonymous-session-init\";\nimport { ChatIdProvider } from \"@/providers/chat-id-provider\";\n\ntype ChatProvidersProps = {\n  children: React.ReactNode;\n};\n\nexport function ChatProviders({ children }: ChatProvidersProps) {\n  return (\n    <ChatIdProvider>\n      <AnonymousSessionInit />\n      {children}\n    </ChatIdProvider>\n  );\n}\n"],"names":["createAnonymousSession","generateUUID","ANONYMOUS_LIMITS","isValidAnonymousSession","obj","AnonymousSessionInit","session","isPending","useSession","queryClient","useQueryClient","useEffect","existingSession","getAnonymousSession","clearAnonymousSession","newSession","setAnonymousSession","creditsKeys","ChatProviders","children","ChatIdProvider","jsx"],"mappings":"kaAGO,SAASA,GAA2C,CACzD,MAAO,CACL,GAAIC,EAAA,EACJ,iBAAkBC,EAAiB,QACnC,cAAe,IAAK,CAExB,CCMA,SAASC,EAAwBC,EAAmC,CAClE,OACEA,GACA,OAAOA,GAAQ,UACf,OAAOA,EAAI,IAAO,UAClB,OAAOA,EAAI,kBAAqB,WAC/BA,EAAI,qBAAqB,MAAQ,OAAOA,EAAI,WAAc,SAE/D,CAEO,SAASC,GAAuB,CACrC,KAAM,CAAE,KAAMC,EAAS,UAAAC,CAAA,EAAcC,EAAA,EAC/BC,EAAcC,EAAA,EAEpBC,OAAAA,EAAAA,UAAU,IAAM,CAKd,GAHIJ,GAGAD,GAAS,KACX,OAIF,MAAMM,EAAkBC,EAAA,EAExB,GAAID,GAEF,GAAI,CAACT,EAAwBS,CAAe,EAAG,CAC7C,QAAQ,KACN,gFAAA,EAEFE,EAAA,EACA,MAAMC,EAAaf,EAAA,EACnBgB,EAAoBD,CAAU,EAE9BN,EAAY,kBAAkB,CAC5B,SAAUQ,EAAY,SAAA,CACvB,EACD,MACF,MACK,CAEL,MAAMF,EAAaf,EAAA,EACnBgB,EAAoBD,CAAU,EAE9BN,EAAY,kBAAkB,CAC5B,SAAUQ,EAAY,SAAA,CACvB,CACH,CACF,EAAG,CAACX,EAASC,EAAWE,CAAW,CAAC,EAE7B,IACT,CC3DO,SAASS,EAAc,CAAE,SAAAC,GAAgC,CAC9D,cACGC,EAAA,CACC,SAAA,CAAAC,EAAAA,IAAChB,EAAA,EAAqB,EACrBc,CAAA,EACH,CAEJ"}