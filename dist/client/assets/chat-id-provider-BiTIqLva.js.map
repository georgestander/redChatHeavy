{"version":3,"file":"chat-id-provider-BiTIqLva.js","sources":["../../../providers/parse-chat-id-from-pathname.ts","../../../providers/chat-id-provider.tsx"],"sourcesContent":["export type ChatIdType = \"chat\" | \"provisional\";\n\nexport type ParsedChatIdFromPathname =\n  | {\n      type: \"chat\";\n      id: string;\n      source: \"share\" | \"project\" | \"chat\";\n      projectId: string | null;\n    }\n  | {\n      type: \"provisional\";\n      id: null;\n      source: \"project\" | \"home\";\n      projectId: string | null;\n    };\n\nconst SHARE_ROUTE_PATTERN = /^\\/share\\/(.+)$/;\nconst PROJECT_ROUTE_PATTERN = /^\\/project\\/([^/]+)(?:\\/chat\\/(.+))?$/;\nconst CHAT_ROUTE_PATTERN = /^\\/chat\\/(.+)$/;\n\n/**\n * Parse a Next.js pathname into a persisted chat id (if present).\n * Pure function - no side effects, easy to test.\n */\nexport function parseChatIdFromPathname(\n  pathname: string | null\n): ParsedChatIdFromPathname {\n  // /share/:id → shared chat\n  const shareMatch = pathname?.match(SHARE_ROUTE_PATTERN);\n  if (shareMatch) {\n    return {\n      type: \"chat\",\n      id: shareMatch[1],\n      source: \"share\",\n      projectId: null,\n    };\n  }\n\n  // /project/:projectId/chat/:chatId → chat\n  // /project/:projectId → provisional (no chat id in path)\n  const projectMatch = pathname?.match(PROJECT_ROUTE_PATTERN);\n  if (projectMatch) {\n    const projectId = projectMatch[1];\n    const chatId = projectMatch[2];\n    if (chatId) {\n      return { type: \"chat\", id: chatId, source: \"project\", projectId };\n    }\n    return { type: \"provisional\", id: null, source: \"project\", projectId };\n  }\n\n  // /chat/:id → chat\n  const chatMatch = pathname?.match(CHAT_ROUTE_PATTERN);\n  if (chatMatch) {\n    return { type: \"chat\", id: chatMatch[1], source: \"chat\", projectId: null };\n  }\n\n  // / or anything else → provisional\n  return { type: \"provisional\", id: null, source: \"home\", projectId: null };\n}\n","\"use client\";\n\nimport {\n  createContext,\n  type ReactNode,\n  useCallback,\n  useContext,\n  useMemo,\n  useState,\n} from \"react\";\nimport { usePathname } from \"@/hooks/use-navigation\";\nimport { generateUUID } from \"@/lib/utils\";\nimport {\n  type ChatIdType,\n  type ParsedChatIdFromPathname,\n  parseChatIdFromPathname,\n} from \"./parse-chat-id-from-pathname\";\n\ntype ChatIdContextType = {\n  id: string;\n  type: ChatIdType;\n  source: ParsedChatIdFromPathname[\"source\"];\n  isPersisted: boolean;\n  confirmChatId: (chatId: string) => void;\n  refreshChatID: () => void;\n};\n\nconst ChatIdContext = createContext<ChatIdContextType | undefined>(undefined);\n\nexport function ChatIdProvider({ children }: { children: ReactNode }) {\n  const pathname = usePathname();\n  const [{ provisionalChatId, confirmedChatId }, setChatIdState] = useState<{\n    provisionalChatId: string;\n    confirmedChatId: string | null;\n  }>(() => ({\n    provisionalChatId: generateUUID(),\n    confirmedChatId: null,\n  }));\n\n  const resolvedId = useMemo(\n    () => parseChatIdFromPathname(pathname),\n    [pathname]\n  );\n\n  const confirmChatIdPersisted = useCallback(\n    (chatId: string) => {\n      if (chatId !== provisionalChatId) {\n        console.error(\"Chat ID mismatch\", chatId, provisionalChatId);\n        throw new Error(\"Chat ID mismatch\");\n      }\n      setChatIdState((prev) => ({ ...prev, confirmedChatId: chatId }));\n    },\n    [provisionalChatId]\n  );\n\n  const refreshChatID = useCallback(() => {\n    const newId = generateUUID();\n    setChatIdState({ provisionalChatId: newId, confirmedChatId: null });\n    window.history.pushState(null, \"\", \"/\");\n  }, []);\n\n  const value = useMemo(\n    () => ({\n      id: resolvedId.id ?? provisionalChatId,\n      type: resolvedId.type,\n      source: resolvedId.source,\n      isPersisted:\n        (resolvedId.id !== null && resolvedId.id !== provisionalChatId) ||\n        confirmedChatId === provisionalChatId,\n      confirmChatId: confirmChatIdPersisted,\n      refreshChatID,\n    }),\n    [\n      resolvedId.id,\n      resolvedId.type,\n      resolvedId.source,\n      provisionalChatId,\n      confirmedChatId,\n      confirmChatIdPersisted,\n      refreshChatID,\n    ]\n  );\n\n  return (\n    <ChatIdContext.Provider value={value}>{children}</ChatIdContext.Provider>\n  );\n}\n\nexport function useChatId() {\n  const context = useContext(ChatIdContext);\n  if (context === undefined) {\n    throw new Error(\"useChatId must be used within a ChatIdProvider\");\n  }\n  return context;\n}\n"],"names":["SHARE_ROUTE_PATTERN","PROJECT_ROUTE_PATTERN","CHAT_ROUTE_PATTERN","parseChatIdFromPathname","pathname","shareMatch","projectMatch","projectId","chatId","chatMatch","ChatIdContext","createContext","ChatIdProvider","children","usePathname","provisionalChatId","confirmedChatId","setChatIdState","useState","generateUUID","resolvedId","useMemo","confirmChatIdPersisted","useCallback","prev","refreshChatID","newId","value","jsx","useChatId","context","useContext"],"mappings":"oIAgBA,MAAMA,EAAsB,kBACtBC,EAAwB,wCACxBC,EAAqB,iBAMpB,SAASC,EACdC,EAC0B,CAE1B,MAAMC,EAAaD,GAAU,MAAMJ,CAAmB,EACtD,GAAIK,EACF,MAAO,CACL,KAAM,OACN,GAAIA,EAAW,CAAC,EAChB,OAAQ,QACR,UAAW,IAAA,EAMf,MAAMC,EAAeF,GAAU,MAAMH,CAAqB,EAC1D,GAAIK,EAAc,CAChB,MAAMC,EAAYD,EAAa,CAAC,EAC1BE,EAASF,EAAa,CAAC,EAC7B,OAAIE,EACK,CAAE,KAAM,OAAQ,GAAIA,EAAQ,OAAQ,UAAW,UAAAD,CAAA,EAEjD,CAAE,KAAM,cAAe,GAAI,KAAM,OAAQ,UAAW,UAAAA,CAAA,CAC7D,CAGA,MAAME,EAAYL,GAAU,MAAMF,CAAkB,EACpD,OAAIO,EACK,CAAE,KAAM,OAAQ,GAAIA,EAAU,CAAC,EAAG,OAAQ,OAAQ,UAAW,IAAA,EAI/D,CAAE,KAAM,cAAe,GAAI,KAAM,OAAQ,OAAQ,UAAW,IAAA,CACrE,CC/BA,MAAMC,EAAgBC,EAAAA,cAA6C,MAAS,EAErE,SAASC,EAAe,CAAE,SAAAC,GAAqC,CACpE,MAAMT,EAAWU,EAAA,EACX,CAAC,CAAE,kBAAAC,EAAmB,gBAAAC,CAAA,EAAmBC,CAAc,EAAIC,EAAAA,SAG9D,KAAO,CACR,kBAAmBC,EAAA,EACnB,gBAAiB,IAAA,EACjB,EAEIC,EAAaC,EAAAA,QACjB,IAAMlB,EAAwBC,CAAQ,EACtC,CAACA,CAAQ,CAAA,EAGLkB,EAAyBC,EAAAA,YAC5Bf,GAAmB,CAClB,GAAIA,IAAWO,EACb,cAAQ,MAAM,mBAAoBP,EAAQO,CAAiB,EACrD,IAAI,MAAM,kBAAkB,EAEpCE,EAAgBO,IAAU,CAAE,GAAGA,EAAM,gBAAiBhB,GAAS,CACjE,EACA,CAACO,CAAiB,CAAA,EAGdU,EAAgBF,EAAAA,YAAY,IAAM,CACtC,MAAMG,EAAQP,EAAA,EACdF,EAAe,CAAE,kBAAmBS,EAAO,gBAAiB,KAAM,EAClE,OAAO,QAAQ,UAAU,KAAM,GAAI,GAAG,CACxC,EAAG,CAAA,CAAE,EAECC,EAAQN,EAAAA,QACZ,KAAO,CACL,GAAID,EAAW,IAAML,EACrB,KAAMK,EAAW,KACjB,OAAQA,EAAW,OACnB,YACGA,EAAW,KAAO,MAAQA,EAAW,KAAOL,GAC7CC,IAAoBD,EACtB,cAAeO,EACf,cAAAG,CAAA,GAEF,CACEL,EAAW,GACXA,EAAW,KACXA,EAAW,OACXL,EACAC,EACAM,EACAG,CAAA,CACF,EAGF,OACEG,EAAAA,IAAClB,EAAc,SAAd,CAAuB,MAAAiB,EAAe,SAAAd,CAAA,CAAS,CAEpD,CAEO,SAASgB,GAAY,CAC1B,MAAMC,EAAUC,EAAAA,WAAWrB,CAAa,EACxC,GAAIoB,IAAY,OACd,MAAM,IAAI,MAAM,gDAAgD,EAElE,OAAOA,CACT"}