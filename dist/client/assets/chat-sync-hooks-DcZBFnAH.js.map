{"version":3,"file":"chat-sync-hooks-DcZBFnAH.js","sources":["../../../src/lib/query-keys/chat.ts","../../../src/lib/query-keys/document.ts","../../../src/lib/query-keys/project.ts","../../../hooks/chat-sync-hooks.ts"],"sourcesContent":["export const chatKeys = {\n  allChats: (projectId?: string | null) =>\n    [\"chat\", \"allChats\", { projectId: projectId ?? null }] as const,\n  byId: (chatId: string) => [\"chat\", \"byId\", chatId] as const,\n  messages: (chatId: string) => [\"chat\", \"messages\", chatId] as const,\n  publicChat: (chatId: string) => [\"chat\", \"publicChat\", chatId] as const,\n  publicMessages: (chatId: string) =>\n    [\"chat\", \"publicMessages\", chatId] as const,\n} as const;\n","export const documentKeys = {\n  byMessageId: (messageId: string) =>\n    [\"document\", \"byMessageId\", messageId] as const,\n  publicByMessageId: (messageId: string) =>\n    [\"document\", \"publicByMessageId\", messageId] as const,\n} as const;\n","export const projectKeys = {\n  list: [\"project\", \"list\"] as const,\n  byId: (projectId: string) => [\"project\", \"byId\", projectId] as const,\n} as const;\n","\"use client\";\n\n// Hooks for chat data fetching and mutations\n// For authenticated users only - anonymous users don't persist data\n\nimport {\n  type QueryKey,\n  useMutation,\n  useQuery,\n  useQueryClient,\n} from \"@tanstack/react-query\";\nimport { useCallback } from \"react\";\nimport { toast } from \"sonner\";\nimport type { ChatMessage } from \"@/lib/ai/types\";\nimport { getAnonymousSession } from \"@/lib/anonymous-session-client\";\nimport type { Document, Project } from \"@/lib/db/schema\";\nimport {\n  chatKeys,\n  creditsKeys,\n  documentKeys,\n  projectKeys,\n} from \"@/lib/query-keys\";\nimport { ANONYMOUS_LIMITS } from \"@/lib/types/anonymous\";\nimport type { UIChat } from \"@/lib/types/ui-chat\";\nimport { useChatId } from \"@/providers/chat-id-provider\";\nimport { useSession } from \"@/providers/session-provider\";\nimport {\n  cloneSharedChat,\n  deleteChat as deleteChatAction,\n  deleteTrailingMessages,\n  getAllChats,\n  getChatById as getChatByIdAction,\n  getChatMessages,\n  getPublicChatMessages,\n  renameChat,\n  setIsPinned,\n  setVisibility,\n} from \"@/server/actions/chat\";\nimport { getAvailableCredits } from \"@/server/actions/credits\";\nimport {\n  getDocuments,\n  getPublicDocuments,\n  saveDocument as saveDocumentAction,\n} from \"@/server/actions/document\";\nimport {\n  getById as getProjectById,\n  update as updateProject,\n} from \"@/server/actions/project\";\n\n// Query key for anonymous credits - allows invalidation after messages\nconst ANONYMOUS_CREDITS_KEY = [\"anonymousCredits\"] as const;\n\ntype SerializedChat = Omit<UIChat, \"createdAt\" | \"updatedAt\"> & {\n  createdAt: string | Date;\n  updatedAt: string | Date;\n};\n\ntype SerializedProject = Omit<Project, \"createdAt\" | \"updatedAt\"> & {\n  createdAt: string | Date;\n  updatedAt: string | Date;\n};\n\ntype SerializedChatMessage = Omit<ChatMessage, \"metadata\"> & {\n  metadata: Omit<ChatMessage[\"metadata\"], \"createdAt\"> & {\n    createdAt: string | Date;\n  };\n};\n\nfunction hydrateChatDates(chat: SerializedChat): UIChat {\n  return {\n    ...chat,\n    createdAt:\n      chat.createdAt instanceof Date\n        ? chat.createdAt\n        : new Date(chat.createdAt),\n    updatedAt:\n      chat.updatedAt instanceof Date\n        ? chat.updatedAt\n        : new Date(chat.updatedAt),\n  };\n}\n\nfunction hydrateProjectDates(project: SerializedProject): Project {\n  return {\n    ...project,\n    createdAt:\n      project.createdAt instanceof Date\n        ? project.createdAt\n        : new Date(project.createdAt),\n    updatedAt:\n      project.updatedAt instanceof Date\n        ? project.updatedAt\n        : new Date(project.updatedAt),\n  };\n}\n\nfunction hydrateMessageDates(message: SerializedChatMessage): ChatMessage {\n  return {\n    ...message,\n    metadata: {\n      ...message.metadata,\n      createdAt:\n        message.metadata.createdAt instanceof Date\n          ? message.metadata.createdAt\n          : new Date(message.metadata.createdAt),\n    },\n  };\n}\n\nfunction snapshotAllChatsQueries(\n  qc: ReturnType<typeof useQueryClient>,\n  key: QueryKey\n) {\n  return qc.getQueriesData<UIChat[]>({ queryKey: key });\n}\n\nfunction restoreAllChatsQueries(\n  qc: ReturnType<typeof useQueryClient>,\n  snapshot: [QueryKey, UIChat[] | undefined][]\n) {\n  for (const [k, data] of snapshot) {\n    qc.setQueryData(k, data);\n  }\n}\n\nfunction updateAllChatsQueries(\n  qc: ReturnType<typeof useQueryClient>,\n  key: QueryKey,\n  updater: (old: UIChat[] | undefined) => UIChat[] | undefined\n) {\n  const entries = qc.getQueriesData<UIChat[]>({ queryKey: key });\n  for (const [k] of entries) {\n    qc.setQueryData<UIChat[] | undefined>(k, updater);\n  }\n}\n\nexport function useProject(\n  projectId: string | null,\n  { enabled }: { enabled?: boolean } = {}\n) {\n  const { data: session } = useSession();\n\n  return useQuery({\n    queryKey: projectKeys.byId(projectId ?? \"\"),\n    queryFn: async () => {\n      const project = await getProjectById({ id: projectId ?? \"\" });\n      return hydrateProjectDates(project as SerializedProject);\n    },\n    enabled: (enabled ?? true) && !!session?.user && !!projectId,\n  });\n}\n\nexport function useGetChatMessagesQueryOptions() {\n  const { data: session } = useSession();\n  const { id: chatId, isPersisted, source } = useChatId();\n  const isShared = source === \"share\";\n\n  const queryKey = isShared\n    ? chatKeys.publicMessages(chatId || \"\")\n    : chatKeys.messages(chatId || \"\");\n\n  return {\n    queryKey,\n    queryFn: async () => {\n      const messages = isShared\n        ? await getPublicChatMessages({ chatId: chatId || \"\" })\n        : await getChatMessages({ chatId: chatId || \"\" });\n      return (messages as SerializedChatMessage[]).map(hydrateMessageDates);\n    },\n    enabled: !!chatId && isPersisted && (isShared || !!session?.user),\n  };\n}\n\nexport function useDeleteChat() {\n  const { data: session } = useSession();\n  const isAuthenticated = !!session?.user;\n  const qc = useQueryClient();\n  const allChatsKey = chatKeys.allChats(null).slice(0, 2) as QueryKey;\n\n  const deleteMutation = useMutation({\n    mutationFn: ({ chatId }: { chatId: string }) =>\n      deleteChatAction({ chatId }),\n    onMutate: async ({\n      chatId,\n    }): Promise<{\n      previousAllChats?: [QueryKey, UIChat[] | undefined][];\n    }> => {\n      if (!isAuthenticated) {\n        return { previousAllChats: undefined };\n      }\n      const snapshot = snapshotAllChatsQueries(qc, allChatsKey);\n      await qc.cancelQueries({ queryKey: allChatsKey, exact: false });\n      updateAllChatsQueries(\n        qc,\n        allChatsKey,\n        (old) => old?.filter((c) => c.id !== chatId) ?? old\n      );\n      return { previousAllChats: snapshot };\n    },\n    onError: (_err, _vars, ctx) => {\n      if (ctx?.previousAllChats) {\n        restoreAllChatsQueries(qc, ctx.previousAllChats);\n      }\n    },\n    onSettled: () => {\n      qc.invalidateQueries({ queryKey: allChatsKey, exact: false });\n    },\n  });\n\n  const deleteChatHandler = useCallback(\n    async (\n      chatId: string,\n      options?: { onSuccess?: () => void; onError?: (error: Error) => void }\n    ) => {\n      if (!isAuthenticated) {\n        return;\n      }\n      try {\n        await deleteMutation.mutateAsync({ chatId });\n        options?.onSuccess?.();\n      } catch (error) {\n        const err = error instanceof Error ? error : new Error(\"Unknown error\");\n        options?.onError?.(err);\n        throw err;\n      }\n    },\n    [deleteMutation, isAuthenticated]\n  );\n\n  return { deleteChat: deleteChatHandler };\n}\n\nexport function useRenameChat() {\n  const { data: session } = useSession();\n  const isAuthenticated = !!session?.user;\n  const qc = useQueryClient();\n  const allChatsKey = chatKeys.allChats(null).slice(0, 2) as QueryKey;\n\n  return useMutation({\n    mutationFn: ({ chatId, title }: { chatId: string; title: string }) =>\n      renameChat({ chatId, title }),\n    onMutate: async ({\n      chatId,\n      title,\n    }): Promise<{\n      previousAllChats?: [QueryKey, UIChat[] | undefined][];\n      previousChatById?: UIChat | null;\n    }> => {\n      if (!isAuthenticated) {\n        return { previousAllChats: undefined, previousChatById: undefined };\n      }\n      const byIdKey = chatKeys.byId(chatId);\n\n      await Promise.all([\n        qc.cancelQueries({ queryKey: allChatsKey, exact: false }),\n        qc.cancelQueries({ queryKey: byIdKey }),\n      ]);\n\n      const previousAllChats = snapshotAllChatsQueries(qc, allChatsKey);\n      const previousChatById = qc.getQueryData<UIChat | null>(byIdKey);\n\n      updateAllChatsQueries(\n        qc,\n        allChatsKey,\n        (old) => old?.map((c) => (c.id === chatId ? { ...c, title } : c)) ?? old\n      );\n      if (previousChatById) {\n        qc.setQueryData<UIChat | null>(byIdKey, { ...previousChatById, title });\n      }\n\n      return { previousAllChats, previousChatById };\n    },\n    onError: (_err, { chatId }, ctx) => {\n      if (ctx?.previousAllChats) {\n        restoreAllChatsQueries(qc, ctx.previousAllChats);\n      }\n      if (ctx?.previousChatById !== undefined) {\n        qc.setQueryData(\n          chatKeys.byId(chatId),\n          ctx.previousChatById ?? undefined\n        );\n      }\n      toast.error(\"Failed to rename chat\");\n    },\n    onSettled: async (_data, _error, { chatId }) => {\n      await Promise.all([\n        qc.invalidateQueries({ queryKey: allChatsKey, exact: false }),\n        qc.invalidateQueries({\n          queryKey: chatKeys.byId(chatId),\n        }),\n      ]);\n    },\n  });\n}\n\nexport function useRenameProject() {\n  const qc = useQueryClient();\n\n  return useMutation({\n    mutationFn: (variables: { id: string; updates: Partial<Project> }) =>\n      updateProject({ id: variables.id, updates: variables.updates }),\n    onMutate: async (variables) => {\n      const listKey = projectKeys.list;\n      await qc.cancelQueries({ queryKey: listKey });\n      const previous = qc.getQueryData<Project[]>(listKey);\n      const nextName =\n        typeof variables.updates.name === \"string\"\n          ? variables.updates.name\n          : undefined;\n      if (nextName) {\n        qc.setQueryData<Project[] | undefined>(listKey, (old) =>\n          old?.map((p) =>\n            p.id === variables.id ? { ...p, name: nextName } : p\n          )\n        );\n      }\n      return { previous };\n    },\n    onError: (_error, _variables, ctx) => {\n      if (ctx?.previous) {\n        qc.setQueryData(projectKeys.list, ctx.previous);\n      }\n      toast.error(\"Failed to rename project\");\n    },\n    onSuccess: () => toast.success(\"Project renamed\"),\n    onSettled: () => qc.invalidateQueries({ queryKey: projectKeys.list }),\n  });\n}\n\nexport function usePinChat() {\n  const { data: session } = useSession();\n  const isAuthenticated = !!session?.user;\n  const qc = useQueryClient();\n  const allChatsKey = chatKeys.allChats(null).slice(0, 2) as QueryKey;\n\n  return useMutation({\n    mutationFn: ({ chatId, isPinned }: { chatId: string; isPinned: boolean }) =>\n      setIsPinned({ chatId, isPinned }),\n    onMutate: async ({\n      chatId,\n      isPinned,\n    }): Promise<{\n      previousAllChats?: [QueryKey, UIChat[] | undefined][];\n    }> => {\n      if (!isAuthenticated) {\n        return { previousAllChats: undefined };\n      }\n      const snapshot = snapshotAllChatsQueries(qc, allChatsKey);\n      await qc.cancelQueries({ queryKey: allChatsKey, exact: false });\n      updateAllChatsQueries(\n        qc,\n        allChatsKey,\n        (old) =>\n          old?.map((c) => (c.id === chatId ? { ...c, isPinned } : c)) ?? old\n      );\n      return { previousAllChats: snapshot };\n    },\n    onError: (_err, _vars, ctx) => {\n      if (ctx?.previousAllChats) {\n        restoreAllChatsQueries(qc, ctx.previousAllChats);\n      }\n      toast.error(\"Failed to pin chat\");\n    },\n    onSettled: async (_data, _error, { chatId }) => {\n      await Promise.all([\n        qc.invalidateQueries({ queryKey: allChatsKey, exact: false }),\n        qc.invalidateQueries({\n          queryKey: chatKeys.byId(chatId),\n        }),\n      ]);\n    },\n  });\n}\n\nfunction _useDeleteTrailingMessages() {\n  const { data: session } = useSession();\n  const isAuthenticated = !!session?.user;\n  const qc = useQueryClient();\n\n  return useMutation({\n    mutationFn: ({ messageId }: { messageId: string; chatId: string }) =>\n      deleteTrailingMessages({ messageId }),\n    onMutate: async ({\n      messageId,\n      chatId,\n    }): Promise<{ previousMessages?: ChatMessage[]; chatId: string }> => {\n      if (!isAuthenticated) {\n        return { previousMessages: undefined, chatId };\n      }\n      const key = chatKeys.messages(chatId);\n      await qc.cancelQueries({ queryKey: key });\n      const previousMessages = qc.getQueryData<ChatMessage[]>(key);\n      qc.setQueryData<ChatMessage[] | undefined>(key, (old) => {\n        if (!old) {\n          return old;\n        }\n        const idx = old.findIndex((msg) => msg.id === messageId);\n        return idx === -1 ? old : old.slice(0, idx);\n      });\n      return { previousMessages, chatId };\n    },\n    onError: (_err, { chatId }, ctx) => {\n      if (ctx?.previousMessages) {\n        qc.setQueryData(chatKeys.messages(chatId), ctx.previousMessages);\n      }\n      toast.error(\"Failed to delete messages\");\n    },\n    onSuccess: (_data, { chatId }) => {\n      qc.invalidateQueries({\n        queryKey: chatKeys.messages(chatId),\n      });\n      toast.success(\"Messages deleted\");\n    },\n  });\n}\n\nexport function useCloneChat() {\n  const qc = useQueryClient();\n  const allChatsKey = chatKeys.allChats(null).slice(0, 2) as QueryKey;\n\n  return useMutation({\n    mutationFn: ({ chatId }: { chatId: string }) => cloneSharedChat({ chatId }),\n    onSettled: () => qc.refetchQueries({ queryKey: allChatsKey, exact: false }),\n    onError: (error) => console.error(\"Failed to copy chat:\", error),\n  });\n}\n\nexport function useSaveMessageMutation() {\n  const { data: session } = useSession();\n  const isAuthenticated = !!session?.user;\n  const qc = useQueryClient();\n  const allChatsKey = chatKeys.allChats(null).slice(0, 2) as QueryKey;\n\n  return useMutation({\n    // Message is saved in the backend by another route. This doesn't need to actually mutate\n    mutationFn: (_: { message: ChatMessage; chatId: string }) =>\n      Promise.resolve({ success: true } as const),\n    onMutate: async ({ message, chatId }) => {\n      const key = chatKeys.messages(chatId);\n      await qc.cancelQueries({ queryKey: key });\n      const previousMessages = qc.getQueryData<ChatMessage[]>(key);\n      qc.setQueryData<ChatMessage[]>(key, (old) =>\n        old ? [...old, message] : [message]\n      );\n      return { previousMessages, chatId };\n    },\n    onSuccess: async (_data, { message, chatId }) => {\n      if (message.role === \"assistant\") {\n        if (isAuthenticated) {\n          qc.invalidateQueries({\n            queryKey: creditsKeys.available,\n          });\n          await Promise.all([\n            qc.invalidateQueries({\n              queryKey: allChatsKey,\n              exact: false,\n            }),\n            qc.invalidateQueries({\n              queryKey: chatKeys.byId(chatId),\n            }),\n          ]);\n        } else {\n          // Refresh anonymous credits from cookie\n          qc.invalidateQueries({ queryKey: ANONYMOUS_CREDITS_KEY });\n        }\n      }\n    },\n  });\n}\n\nexport function useSetVisibility() {\n  const qc = useQueryClient();\n  const allChatsKey = chatKeys.allChats(null).slice(0, 2) as QueryKey;\n\n  return useMutation({\n    mutationFn: ({\n      chatId,\n      visibility,\n    }: {\n      chatId: string;\n      visibility: \"private\" | \"public\";\n    }) => setVisibility({ chatId, visibility }),\n    onError: () => toast.error(\"Failed to update chat visibility\"),\n    onSettled: () =>\n      qc.invalidateQueries({\n        queryKey: allChatsKey,\n        exact: false,\n      }),\n    onSuccess: (_data, { visibility }) => {\n      toast.success(\n        visibility === \"public\"\n          ? \"Chat is now public - anyone with the link can access it\"\n          : \"Chat is now private - only you can access it\"\n      );\n    },\n  });\n}\n\nexport function useSaveDocument(\n  _documentId: string,\n  messageId: string,\n  options?: {\n    onSettled?: (result: unknown, error: unknown, params: unknown) => void;\n  }\n) {\n  const qc = useQueryClient();\n  const { data: session } = useSession();\n  const userId = session?.user?.id;\n\n  return useMutation({\n    mutationFn: saveDocumentAction,\n    onMutate: async (newDoc): Promise<{ previousDocuments: Document[] }> => {\n      const key = documentKeys.byMessageId(newDoc.id);\n      await qc.cancelQueries({ queryKey: key });\n      const previousDocuments = qc.getQueryData<Document[]>(key) ?? [];\n      qc.setQueryData(key, [\n        ...previousDocuments,\n        {\n          id: newDoc.id,\n          createdAt: new Date(),\n          title: newDoc.title,\n          content: newDoc.content,\n          kind: newDoc.kind,\n          userId: userId || \"\",\n          messageId,\n        } as Document,\n      ]);\n      return { previousDocuments };\n    },\n    onError: (_err, newDoc, ctx) => {\n      if (ctx?.previousDocuments) {\n        qc.setQueryData(\n          documentKeys.byMessageId(newDoc.id),\n          ctx.previousDocuments\n        );\n      }\n    },\n    onSettled: (result, error, params) => {\n      qc.invalidateQueries({\n        queryKey: documentKeys.byMessageId(params.id as string),\n      });\n      options?.onSettled?.(result, error, params);\n    },\n  });\n}\n\nexport function useDocuments(id: string, disable: boolean) {\n  const { source } = useChatId();\n  const isShared = source === \"share\";\n  const { data: session } = useSession();\n\n  return useQuery({\n    queryKey: isShared\n      ? documentKeys.publicByMessageId(id)\n      : documentKeys.byMessageId(id),\n    queryFn: () =>\n      isShared ? getPublicDocuments({ id }) : getDocuments({ id }),\n    enabled: !disable && !!id && (isShared || !!session?.user),\n  });\n}\n\nexport function useGetAllChats(opts?: {\n  projectId?: string | null;\n  limit?: number;\n}) {\n  const { data: session } = useSession();\n  const { projectId, limit } = opts ?? {};\n\n  return useQuery({\n    queryKey: chatKeys.allChats(projectId ?? null),\n    queryFn: async () => {\n      const chats = await getAllChats({ projectId: projectId ?? null });\n      return (chats as SerializedChat[]).map(hydrateChatDates);\n    },\n    enabled: !!session?.user,\n    select: limit ? (data: UIChat[]) => data.slice(0, limit) : undefined,\n  });\n}\n\nexport function useGetChatByIdQueryOptions(chatId: string) {\n  const { data: session } = useSession();\n\n  return {\n    queryKey: chatKeys.byId(chatId),\n    queryFn: async () => {\n      const chat = await getChatByIdAction({ chatId });\n      return hydrateChatDates(chat as SerializedChat);\n    },\n    enabled: !!chatId && !!session?.user,\n  };\n}\n\nexport function useGetChatById(\n  chatId: string,\n  { enabled }: { enabled?: boolean } = {}\n) {\n  const options = useGetChatByIdQueryOptions(chatId);\n  return useQuery({\n    ...options,\n    enabled: (enabled ?? true) && (options.enabled ?? true),\n  });\n}\n\nexport function useGetCredits() {\n  const { data: session } = useSession();\n  const isAuthenticated = !!session?.user;\n\n  const { data: creditsData, isLoading: isLoadingCredits } = useQuery({\n    queryKey: creditsKeys.available,\n    queryFn: getAvailableCredits,\n    enabled: isAuthenticated,\n  });\n\n  // Use a query for anonymous credits so we can invalidate it\n  const { data: anonymousCredits } = useQuery({\n    queryKey: ANONYMOUS_CREDITS_KEY,\n    queryFn: () => {\n      const anonymousSession = getAnonymousSession();\n      return anonymousSession?.remainingCredits ?? ANONYMOUS_LIMITS.CREDITS;\n    },\n    enabled: !isAuthenticated,\n    staleTime: 0,\n  });\n\n  if (!isAuthenticated) {\n    return {\n      credits: anonymousCredits ?? ANONYMOUS_LIMITS.CREDITS,\n      isLoadingCredits: false,\n    };\n  }\n\n  return {\n    credits: creditsData?.credits,\n    isLoadingCredits,\n  };\n}\n"],"names":["chatKeys","projectId","chatId","documentKeys","messageId","projectKeys","ANONYMOUS_CREDITS_KEY","hydrateChatDates","chat","hydrateProjectDates","project","hydrateMessageDates","message","snapshotAllChatsQueries","qc","key","restoreAllChatsQueries","snapshot","k","data","updateAllChatsQueries","updater","entries","useProject","enabled","session","useSession","useQuery","getProjectById","useGetChatMessagesQueryOptions","isPersisted","source","useChatId","isShared","getPublicChatMessages","getChatMessages","useDeleteChat","isAuthenticated","useQueryClient","allChatsKey","deleteMutation","useMutation","deleteChatAction","old","c","_err","_vars","ctx","useCallback","options","error","err","useRenameChat","title","renameChat","byIdKey","previousAllChats","previousChatById","toast","_data","_error","useRenameProject","variables","updateProject","listKey","previous","nextName","p","_variables","usePinChat","isPinned","setIsPinned","useCloneChat","cloneSharedChat","useSaveMessageMutation","_","previousMessages","creditsKeys","useSetVisibility","visibility","setVisibility","useSaveDocument","_documentId","userId","saveDocumentAction","newDoc","previousDocuments","result","params","useDocuments","id","disable","getPublicDocuments","getDocuments","useGetAllChats","opts","limit","getAllChats","useGetChatByIdQueryOptions","getChatByIdAction","useGetChatById","useGetCredits","creditsData","isLoadingCredits","getAvailableCredits","anonymousCredits","getAnonymousSession","ANONYMOUS_LIMITS"],"mappings":"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"}