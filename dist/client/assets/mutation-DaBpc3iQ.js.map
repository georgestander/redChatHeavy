{"version":3,"file":"mutation-DaBpc3iQ.js","sources":["../../../node_modules/.pnpm/@tanstack+query-core@5.75.0/node_modules/@tanstack/query-core/build/modern/mutation.js"],"sourcesContent":["// src/mutation.ts\nimport { notifyManager } from \"./notifyManager.js\";\nimport { Removable } from \"./removable.js\";\nimport { createRetryer } from \"./retryer.js\";\nvar Mutation = class extends Removable {\n  #observers;\n  #mutationCache;\n  #retryer;\n  constructor(config) {\n    super();\n    this.mutationId = config.mutationId;\n    this.#mutationCache = config.mutationCache;\n    this.#observers = [];\n    this.state = config.state || getDefaultState();\n    this.setOptions(config.options);\n    this.scheduleGc();\n  }\n  setOptions(options) {\n    this.options = options;\n    this.updateGcTime(this.options.gcTime);\n  }\n  get meta() {\n    return this.options.meta;\n  }\n  addObserver(observer) {\n    if (!this.#observers.includes(observer)) {\n      this.#observers.push(observer);\n      this.clearGcTimeout();\n      this.#mutationCache.notify({\n        type: \"observerAdded\",\n        mutation: this,\n        observer\n      });\n    }\n  }\n  removeObserver(observer) {\n    this.#observers = this.#observers.filter((x) => x !== observer);\n    this.scheduleGc();\n    this.#mutationCache.notify({\n      type: \"observerRemoved\",\n      mutation: this,\n      observer\n    });\n  }\n  optionalRemove() {\n    if (!this.#observers.length) {\n      if (this.state.status === \"pending\") {\n        this.scheduleGc();\n      } else {\n        this.#mutationCache.remove(this);\n      }\n    }\n  }\n  continue() {\n    return this.#retryer?.continue() ?? // continuing a mutation assumes that variables are set, mutation must have been dehydrated before\n    this.execute(this.state.variables);\n  }\n  async execute(variables) {\n    const onContinue = () => {\n      this.#dispatch({ type: \"continue\" });\n    };\n    this.#retryer = createRetryer({\n      fn: () => {\n        if (!this.options.mutationFn) {\n          return Promise.reject(new Error(\"No mutationFn found\"));\n        }\n        return this.options.mutationFn(variables);\n      },\n      onFail: (failureCount, error) => {\n        this.#dispatch({ type: \"failed\", failureCount, error });\n      },\n      onPause: () => {\n        this.#dispatch({ type: \"pause\" });\n      },\n      onContinue,\n      retry: this.options.retry ?? 0,\n      retryDelay: this.options.retryDelay,\n      networkMode: this.options.networkMode,\n      canRun: () => this.#mutationCache.canRun(this)\n    });\n    const restored = this.state.status === \"pending\";\n    const isPaused = !this.#retryer.canStart();\n    try {\n      if (restored) {\n        onContinue();\n      } else {\n        this.#dispatch({ type: \"pending\", variables, isPaused });\n        await this.#mutationCache.config.onMutate?.(\n          variables,\n          this\n        );\n        const context = await this.options.onMutate?.(variables);\n        if (context !== this.state.context) {\n          this.#dispatch({\n            type: \"pending\",\n            context,\n            variables,\n            isPaused\n          });\n        }\n      }\n      const data = await this.#retryer.start();\n      await this.#mutationCache.config.onSuccess?.(\n        data,\n        variables,\n        this.state.context,\n        this\n      );\n      await this.options.onSuccess?.(data, variables, this.state.context);\n      await this.#mutationCache.config.onSettled?.(\n        data,\n        null,\n        this.state.variables,\n        this.state.context,\n        this\n      );\n      await this.options.onSettled?.(data, null, variables, this.state.context);\n      this.#dispatch({ type: \"success\", data });\n      return data;\n    } catch (error) {\n      try {\n        await this.#mutationCache.config.onError?.(\n          error,\n          variables,\n          this.state.context,\n          this\n        );\n        await this.options.onError?.(\n          error,\n          variables,\n          this.state.context\n        );\n        await this.#mutationCache.config.onSettled?.(\n          void 0,\n          error,\n          this.state.variables,\n          this.state.context,\n          this\n        );\n        await this.options.onSettled?.(\n          void 0,\n          error,\n          variables,\n          this.state.context\n        );\n        throw error;\n      } finally {\n        this.#dispatch({ type: \"error\", error });\n      }\n    } finally {\n      this.#mutationCache.runNext(this);\n    }\n  }\n  #dispatch(action) {\n    const reducer = (state) => {\n      switch (action.type) {\n        case \"failed\":\n          return {\n            ...state,\n            failureCount: action.failureCount,\n            failureReason: action.error\n          };\n        case \"pause\":\n          return {\n            ...state,\n            isPaused: true\n          };\n        case \"continue\":\n          return {\n            ...state,\n            isPaused: false\n          };\n        case \"pending\":\n          return {\n            ...state,\n            context: action.context,\n            data: void 0,\n            failureCount: 0,\n            failureReason: null,\n            error: null,\n            isPaused: action.isPaused,\n            status: \"pending\",\n            variables: action.variables,\n            submittedAt: Date.now()\n          };\n        case \"success\":\n          return {\n            ...state,\n            data: action.data,\n            failureCount: 0,\n            failureReason: null,\n            error: null,\n            status: \"success\",\n            isPaused: false\n          };\n        case \"error\":\n          return {\n            ...state,\n            data: void 0,\n            error: action.error,\n            failureCount: state.failureCount + 1,\n            failureReason: action.error,\n            isPaused: false,\n            status: \"error\"\n          };\n      }\n    };\n    this.state = reducer(this.state);\n    notifyManager.batch(() => {\n      this.#observers.forEach((observer) => {\n        observer.onMutationUpdate(action);\n      });\n      this.#mutationCache.notify({\n        mutation: this,\n        type: \"updated\",\n        action\n      });\n    });\n  }\n};\nfunction getDefaultState() {\n  return {\n    context: void 0,\n    data: void 0,\n    error: null,\n    failureCount: 0,\n    failureReason: null,\n    isPaused: false,\n    status: \"idle\",\n    variables: void 0,\n    submittedAt: 0\n  };\n}\nexport {\n  Mutation,\n  getDefaultState\n};\n//# sourceMappingURL=mutation.js.map"],"names":["Mutation","Removable","#observers","#mutationCache","#retryer","config","getDefaultState","options","observer","x","variables","onContinue","#dispatch","createRetryer","failureCount","error","restored","isPaused","context","data","action","reducer","state","notifyManager"],"mappings":"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","x_google_ignoreList":[0]}