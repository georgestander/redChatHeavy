import{_ as k,a as D,i as b}from"./client-BXVv_YeC.js";const s={RSC_START:0,RSC_CHUNK:1,RSC_END:2,ACTION_REQUEST:3,ACTION_START:4,ACTION_CHUNK:5,ACTION_END:6,ACTION_ERROR:7},h=new TextEncoder,f=new TextDecoder,a=36;function H(r){switch(r.type){case s.ACTION_REQUEST:{const t=r,n=JSON.stringify({id:t.id,args:t.args,requestId:t.requestId,clientUrl:t.clientUrl}),e=h.encode(n),o=new Uint8Array(1+e.length);return o[0]=t.type,o.set(e,1),o}case s.ACTION_START:case s.RSC_START:{const t=r,n=h.encode(t.id);if(n.length!==a)throw new Error("Invalid message ID length for START message");const e=new Uint8Array(3+a),o=new DataView(e.buffer);return o.setUint8(0,t.type),o.setUint16(1,t.status,!1),e.set(n,3),e}case s.ACTION_CHUNK:case s.RSC_CHUNK:{const t=r,n=h.encode(t.id);if(n.length!==a)throw new Error("Invalid message ID length for CHUNK message");const e=new Uint8Array(1+a+t.payload.length);return e[0]=t.type,e.set(n,1),e.set(t.payload,1+a),e}case s.ACTION_END:case s.RSC_END:{const t=r,n=h.encode(t.id);if(n.length!==a)throw new Error("Invalid message ID length for END message");const e=new Uint8Array(1+a);return e[0]=t.type,e.set(n,1),e}case s.ACTION_ERROR:{const t=r,n=h.encode(t.id);if(n.length!==a)throw new Error("Invalid message ID length for ERROR message");const e=JSON.stringify({error:t.error}),o=h.encode(e),c=new Uint8Array(1+a+o.length);return c[0]=t.type,c.set(n,1),c.set(o,1+a),c}default:throw new Error("Unknown message type for packing")}}function N(r){if(r.length===0)throw new Error("Cannot unpack empty message");const t=r[0];switch(t){case s.ACTION_REQUEST:{const n=f.decode(r.slice(1)),e=JSON.parse(n);return{type:t,...e}}case s.ACTION_START:case s.RSC_START:{if(r.length!==3+a)throw new Error("Invalid START message length");const e=new DataView(r.buffer).getUint16(1,!1),o=f.decode(r.slice(3));return{type:t,id:o,status:e}}case s.ACTION_CHUNK:case s.RSC_CHUNK:{if(r.length<1+a)throw new Error("Invalid CHUNK message length");const n=f.decode(r.slice(1,1+a)),e=r.slice(1+a);return{type:t,id:n,payload:e}}case s.ACTION_END:case s.RSC_END:{if(r.length!==1+a)throw new Error("Invalid END message length");const n=f.decode(r.slice(1,1+a));return{type:t,id:n}}case s.ACTION_ERROR:{if(r.length<1+a)throw new Error("Invalid ERROR message length");const n=f.decode(r.slice(1,1+a)),e=f.decode(r.slice(1+a));let o="Unknown error";try{o=JSON.parse(e).error}catch{}return{type:t,id:n,error:o}}default:throw new Error(`Unknown message type for unpacking: ${t}`)}}const L="default",Q=({key:r=L,handleResponse:t})=>n=>{let e=null,o=!1;const c=crypto.randomUUID(),l=new URL(window.location.href),d=l.protocol==="https:";l.protocol="",l.host="";const i=async()=>{if(e)return;const E=d?"wss":"ws";e=new WebSocket(`${E}://${window.location.host}/__realtime?key=${encodeURIComponent(r)}&url=${encodeURIComponent(l.toString())}&clientId=${encodeURIComponent(c)}&shouldForwardResponses=${encodeURIComponent(t?"true":"false")}`),e.binaryType="arraybuffer",e.addEventListener("open",()=>{o=!0}),e.addEventListener("error",p=>{console.error("[Realtime] WebSocket error",p)}),e.addEventListener("close",()=>{console.warn("[Realtime] WebSocket closed, attempting to reconnect..."),e=null,o=!1,setTimeout(i,5e3)}),P(e,p=>{A(p)})},u=()=>{if(!e&&o)throw new Error("Inconsistent state: WebSocket is null but marked as connected");if(!e||!o)throw new Error("WebSocket is not connected");return e},w=async(E,p,C,_)=>{try{const R=u(),{encodeReply:y}=await k(async()=>{const{encodeReply:O}=await import("./client-BXVv_YeC.js").then(v=>v.c);return{encodeReply:O}},[]),T=new URL(window.location.href);T.protocol="",T.host="";const m=p!=null?await y(p):null,g=crypto.randomUUID(),S=H({type:s.ACTION_REQUEST,id:E,args:m,requestId:g,clientUrl:T.toString()}),U=K(g,R);return R.send(S),await A(await U)}catch(R){console.error("[Realtime] Error calling server",R);return}},A=async E=>{try{let p,C=!0;if(n.handleResponse){const[y,T]=E.body.tee(),m=new Response(y,E);p=T,C=n.handleResponse(m)}else p=E.body;if(!C)return;const _=D.createFromReadableStream(p,{callServer:w});n.setRscPayload(_);const R=(await _).actionResult;if(b(R)){const y=R.__rw_action_response;if(!(n.onActionResponse?.(y)===!0)){const m=y.headers.location,g=y.status>=300&&y.status<400;if(m&&g){window.location.href=m;return}}return R}return R}catch(p){throw p}};return i(),w};function K(r,t){const n={start:s.ACTION_START,chunk:s.ACTION_CHUNK,end:s.ACTION_END,error:s.ACTION_ERROR};return new Promise((e,o)=>{const c=l=>{const d=N(new Uint8Array(l.data));if(d.type!==s.ACTION_REQUEST&&d.id===r&&d.type===n.start){const i=d;t.removeEventListener("message",c);const u=I(r,t,n,o),w=new Response(u,{status:i.status,headers:{"Content-Type":"text/plain"}});e(w)}};t.addEventListener("message",c)})}function P(r,t){const n={start:s.RSC_START,chunk:s.RSC_CHUNK,end:s.RSC_END},e=async o=>{const c=N(new Uint8Array(o.data));if(!(c.type===s.ACTION_REQUEST||c.type===s.ACTION_CHUNK||c.type===s.ACTION_END||c.type===s.ACTION_ERROR)&&c.type===n.start){const l=c,d=I(l.id,r,n,u=>{console.error("[Realtime] Error creating update stream",u)}),i=new Response(d,{status:l.status,headers:{"Content-Type":"text/plain"}});t(i)}};r.addEventListener("message",e)}const I=(r,t,n,e)=>{let o=Promise.withResolvers();const c=new ReadableStream({start(d){o.resolve(d)}}),l=async d=>{const i=N(new Uint8Array(d.data));if(i.type===s.ACTION_REQUEST||i.id!==r)return;const u=await o.promise;if(i.type===n.chunk){const w=i;u.enqueue(w.payload)}else if(i.type===n.end)u.close(),t.removeEventListener("message",l);else if(n.error&&i.type===n.error){const w=i;e(new Error(w.error)),t.removeEventListener("message",l)}};return t.addEventListener("message",l),c};export{Q as realtimeTransport};
//# sourceMappingURL=client-bxD1XNUs.js.map
