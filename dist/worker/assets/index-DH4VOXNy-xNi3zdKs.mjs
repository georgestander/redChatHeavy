import{az as N,aA as $}from"./index-CPesPnUn.mjs";import"node:events";import"cloudflare:workers";import"async_hooks";import"node:os";import"node:diagnostics_channel";import"fs";import"events";import"util";import"path";import"assert";import"node:stream";import"module";import"node:path";import"url";import"buffer";import"crypto";import"node:crypto";const H=(d,I)=>{let j=null;const v=N({config:{adapterId:"memory",adapterName:"Memory Adapter",usePlural:!1,debugLogs:I?.debugLogs||!1,supportsArrays:!0,customTransformInput(p){return(p.options.advanced?.database?.useNumberId||p.options.advanced?.database?.generateId==="serial")&&p.field==="id"&&p.action==="create"?d[p.model].length+1:p.data},transaction:async p=>{const O=structuredClone(d);try{return await p(v(j))}catch(b){throw Object.keys(d).forEach(A=>{d[A]=O[A]}),b}}},adapter:({getFieldName:p,options:O,getModelName:b})=>{const A=(e,r,c)=>r?e.sort((o,l)=>{const f=p({model:c,field:r.field}),u=o[f],t=l[f];let n=0;return u==null&&t==null?n=0:u==null?n=-1:t==null?n=1:typeof u=="string"&&typeof t=="string"?n=u.localeCompare(t):u instanceof Date&&t instanceof Date?n=u.getTime()-t.getTime():typeof u=="number"&&typeof t=="number"?n=u-t:typeof u=="boolean"&&typeof t=="boolean"?n=u===t?0:u?1:-1:n=String(u).localeCompare(String(t)),r.direction==="asc"?n:-n}):e;function g(e,r,c){const o=(t,n)=>{const h=d[n];if(!h)throw $.error(`[MemoryAdapter] Model ${n} not found in the DB`,Object.keys(d)),new Error(`Model ${n} not found`);const y=(s,m)=>{const{field:i,value:a,operator:w}=m;switch(w){case"in":if(!Array.isArray(a))throw new Error("Value must be an array");return a.includes(s[i]);case"not_in":if(!Array.isArray(a))throw new Error("Value must be an array");return!a.includes(s[i]);case"contains":return s[i].includes(a);case"starts_with":return s[i].startsWith(a);case"ends_with":return s[i].endsWith(a);case"ne":return s[i]!==a;case"gt":return a!=null&&s[i]>a;case"gte":return a!=null&&s[i]>=a;case"lt":return a!=null&&s[i]<a;case"lte":return a!=null&&s[i]<=a;default:return s[i]===a}};return h.filter(s=>{if(!t.length||t.length===0)return!0;let m=y(s,t[0]);for(const i of t){const a=y(s,i);i.connector==="OR"?m=m||a:m=m&&a}return m})};if(!c)return o(e,r);const l=o(e,r),f=new Map,u=new Map;for(const t of l){const n=String(t.id);if(!f.has(n)){const y={...t};for(const[s,m]of Object.entries(c)){const i=b(s);m.relation==="one-to-one"?y[i]=null:(y[i]=[],u.set(`${n}-${s}`,new Set))}f.set(n,y)}const h=f.get(n);for(const[y,s]of Object.entries(c)){const m=b(y),i=d[m];if(!i)throw $.error(`[MemoryAdapter] JoinOption model ${m} not found in the DB`,Object.keys(d)),new Error(`JoinOption model ${m} not found`);const a=i.filter(w=>w[s.on.to]===t[s.on.from]);if(s.relation==="one-to-one")h[m]=a[0]||null;else{const w=u.get(`${n}-${y}`),C=s.limit??100;let E=0;for(const M of a){if(E>=C)break;w.has(M.id)||(h[m].push(M),w.add(M.id),E++)}}}}return Array.from(f.values())}return{create:async({model:e,data:r})=>((O.advanced?.database?.useNumberId||O.advanced?.database?.generateId==="serial")&&(r.id=d[b(e)].length+1),d[e]||(d[e]=[]),d[e].push(r),r),findOne:async({model:e,where:r,join:c})=>{const o=g(r,e,c);if(c){const l=o;return l.length?l[0]:null}return o[0]||null},findMany:async({model:e,where:r,sortBy:c,limit:o,offset:l,join:f})=>{const u=g(r||[],e,f);if(f){const n=u;if(!n.length)return[];A(n,c,e);let h=n;return l!==void 0&&(h=h.slice(l)),o!==void 0&&(h=h.slice(0,o)),h}let t=A(u,c,e);return l!==void 0&&(t=t.slice(l)),o!==void 0&&(t=t.slice(0,o)),t||[]},count:async({model:e,where:r})=>r?g(r,e).length:d[e].length,update:async({model:e,where:r,update:c})=>{const o=g(r,e);return o.forEach(l=>{Object.assign(l,c)}),o[0]||null},delete:async({model:e,where:r})=>{const c=d[e],o=g(r,e);d[e]=c.filter(l=>!o.includes(l))},deleteMany:async({model:e,where:r})=>{const c=d[e],o=g(r,e);let l=0;return d[e]=c.filter(f=>o.includes(f)?(l++,!1):!o.includes(f)),l},updateMany({model:e,where:r,update:c}){const o=g(r,e);return o.forEach(l=>{Object.assign(l,c)}),o[0]||null}}}});return p=>(j=p,v(p))};export{H as memoryAdapter};
//# sourceMappingURL=index-DH4VOXNy-xNi3zdKs.mjs.map
