{"version":3,"file":"document-Caj9SmU3.mjs","sources":["../../../src/lib/schemas/document.ts","../../../src/server/actions/document.ts"],"sourcesContent":["import { z } from \"zod\";\nimport type { ArtifactKind } from \"@/lib/artifacts/artifact-kind\";\n\nexport const documentIdInputSchema = z.object({ id: z.string() });\n\nexport const saveDocumentInputSchema = z.object({\n  id: z.string(),\n  content: z.string(),\n  title: z.string(),\n  kind: z.custom<ArtifactKind>(),\n});\n","\"use server\";\n\nimport { requestInfo } from \"rwsdk/worker\";\nimport type { z } from \"zod\";\nimport { auth } from \"@/lib/auth\";\nimport {\n  getDocumentById,\n  getDocumentsById,\n  getPublicDocumentsById,\n  saveDocument as saveDocumentQuery,\n} from \"@/lib/db/queries\";\nimport {\n  documentIdInputSchema,\n  saveDocumentInputSchema,\n} from \"@/lib/schemas/document\";\n\ntype DocumentIdInput = z.infer<typeof documentIdInputSchema>;\ntype SaveDocumentInput = z.infer<typeof saveDocumentInputSchema>;\n\nasync function requireUser() {\n  const session = await auth.api.getSession({\n    headers: requestInfo.request.headers,\n  });\n\n  if (!session?.user) {\n    throw new Error(\"UNAUTHORIZED\");\n  }\n\n  const { id, ...rest } = session.user;\n  if (!id) {\n    console.error(\"User ID missing in session callback\");\n    throw new Error(\"UNAUTHORIZED\");\n  }\n\n  return { id, ...rest };\n}\n\nexport async function getDocuments(input: DocumentIdInput) {\n  const user = await requireUser();\n  const parsed = documentIdInputSchema.parse(input);\n  const documents = await getDocumentsById({\n    id: parsed.id,\n    userId: user.id,\n  });\n\n  if (documents.length === 0) {\n    throw new Error(\"Document not found\");\n  }\n\n  return documents;\n}\n\nexport async function getPublicDocuments(input: DocumentIdInput) {\n  const parsed = documentIdInputSchema.parse(input);\n  const documents = await getPublicDocumentsById({ id: parsed.id });\n\n  if (documents.length === 0) {\n    throw new Error(\"Public document not found\");\n  }\n\n  return documents;\n}\n\nexport async function saveDocument(input: SaveDocumentInput) {\n  const user = await requireUser();\n  const parsed = saveDocumentInputSchema.parse(input);\n  const lastDocument = await getDocumentById({ id: parsed.id });\n\n  if (!lastDocument) {\n    throw new Error(\"Document not found\");\n  }\n\n  await saveDocumentQuery({\n    id: parsed.id,\n    content: parsed.content,\n    title: parsed.title,\n    kind: parsed.kind,\n    userId: user.id,\n    messageId: lastDocument.messageId,\n  });\n\n  return { success: true };\n}\n"],"names":["documentIdInputSchema","z.object","z.string","saveDocumentInputSchema","z.custom","requireUser","session","auth","requestInfo","id","rest","getDocuments","input","user","parsed","documents","getDocumentsById","getPublicDocuments","getPublicDocumentsById","saveDocument","lastDocument","getDocumentById","saveDocumentQuery"],"mappings":"wpBAGO,MAAMA,EAAwBC,EAAS,CAAE,GAAIC,EAAE,EAAU,EAEnDC,EAA0BF,EAAS,CAC9C,GAAIC,EAAE,EACN,QAASA,EAAE,EACX,MAAOA,EAAE,EACT,KAAME,EAAE,CACV,CAAC,ECSD,eAAeC,GAAc,CAC3B,MAAMC,EAAU,MAAMC,EAAK,IAAI,WAAW,CACxC,QAASC,EAAY,QAAQ,OAAA,CAC9B,EAED,GAAI,CAACF,GAAS,KACZ,MAAM,IAAI,MAAM,cAAc,EAGhC,KAAM,CAAE,GAAAG,EAAI,GAAGC,CAAA,EAASJ,EAAQ,KAChC,GAAI,CAACG,EACH,cAAQ,MAAM,qCAAqC,EAC7C,IAAI,MAAM,cAAc,EAGhC,MAAO,CAAE,GAAAA,EAAI,GAAGC,CAAA,CAClB,CAEA,eAAsBC,EAAaC,EAAwB,CACzD,MAAMC,EAAO,MAAMR,EAAA,EACbS,EAASd,EAAsB,MAAMY,CAAK,EAC1CG,EAAY,MAAMC,EAAiB,CACvC,GAAIF,EAAO,GACX,OAAQD,EAAK,EAAA,CACd,EAED,GAAIE,EAAU,SAAW,EACvB,MAAM,IAAI,MAAM,oBAAoB,EAGtC,OAAOA,CACT,CAEA,eAAsBE,EAAmBL,EAAwB,CAC/D,MAAME,EAASd,EAAsB,MAAMY,CAAK,EAC1CG,EAAY,MAAMG,EAAuB,CAAE,GAAIJ,EAAO,GAAI,EAEhE,GAAIC,EAAU,SAAW,EACvB,MAAM,IAAI,MAAM,2BAA2B,EAG7C,OAAOA,CACT,CAEA,eAAsBI,EAAaP,EAA0B,CAC3D,MAAMC,EAAO,MAAMR,EAAA,EACbS,EAASX,EAAwB,MAAMS,CAAK,EAC5CQ,EAAe,MAAMC,EAAgB,CAAE,GAAIP,EAAO,GAAI,EAE5D,GAAI,CAACM,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,aAAME,EAAkB,CACtB,GAAIR,EAAO,GACX,QAASA,EAAO,QAChB,MAAOA,EAAO,MACd,KAAMA,EAAO,KACb,OAAQD,EAAK,GACb,UAAWO,EAAa,SAAA,CACzB,EAEM,CAAE,QAAS,EAAA,CACpB"}