{"version":3,"file":"vote-sJwKlae4.mjs","sources":["../../../src/lib/schemas/vote.ts","../../../src/server/actions/vote.ts"],"sourcesContent":["import { z } from \"zod\";\n\nexport const getVotesInputSchema = z.object({ chatId: z.string() });\nexport const voteMessageInputSchema = z.object({\n  chatId: z.string(),\n  messageId: z.string(),\n  type: z.enum([\"up\", \"down\"]),\n});\n","\"use server\";\n\nimport { requestInfo } from \"rwsdk/worker\";\nimport { auth } from \"@/lib/auth\";\nimport {\n  getChatById,\n  getVotesByChatId,\n  voteMessage as saveVoteMessage,\n} from \"@/lib/db/queries\";\nimport {\n  getVotesInputSchema,\n  voteMessageInputSchema,\n} from \"@/lib/schemas/vote\";\n\nasync function requireUserId() {\n  const session = await auth.api.getSession({\n    headers: requestInfo.request.headers,\n  });\n  const userId = session?.user?.id;\n  if (!userId) {\n    throw new Error(\"UNAUTHORIZED\");\n  }\n  return userId;\n}\n\nexport async function getVotes(input: unknown) {\n  const userId = await requireUserId();\n  const parsed = getVotesInputSchema.parse(input);\n\n  const chat = await getChatById({ id: parsed.chatId });\n\n  if (!chat) {\n    throw new Error(\"Chat not found\");\n  }\n\n  if (chat.userId !== userId) {\n    throw new Error(\"UNAUTHORIZED\");\n  }\n\n  return await getVotesByChatId({ id: parsed.chatId });\n}\n\nexport async function voteMessage(input: unknown) {\n  const userId = await requireUserId();\n  const parsed = voteMessageInputSchema.parse(input);\n\n  const chat = await getChatById({ id: parsed.chatId });\n\n  if (!chat) {\n    throw new Error(\"Chat not found\");\n  }\n\n  if (chat.userId !== userId) {\n    throw new Error(\"UNAUTHORIZED\");\n  }\n\n  await saveVoteMessage({\n    chatId: parsed.chatId,\n    messageId: parsed.messageId,\n    type: parsed.type,\n  });\n\n  return { success: true };\n}\n"],"names":["getVotesInputSchema","z.object","z.string","voteMessageInputSchema","z.enum","requireUserId","userId","auth","requestInfo","getVotes","input","parsed","chat","getChatById","getVotesByChatId","voteMessage","saveVoteMessage"],"mappings":"4oBAEO,MAAMA,EAAsBC,EAAS,CAAE,OAAQC,EAAE,EAAU,EACrDC,EAAyBF,EAAS,CAC7C,OAAQC,EAAE,EACV,UAAWA,EAAE,EACb,KAAME,EAAO,CAAC,KAAM,MAAM,CAAC,CAC7B,CAAC,ECOD,eAAeC,GAAgB,CAI7B,MAAMC,GAHU,MAAMC,EAAK,IAAI,WAAW,CACxC,QAASC,EAAY,QAAQ,OAAA,CAC9B,IACuB,MAAM,GAC9B,GAAI,CAACF,EACH,MAAM,IAAI,MAAM,cAAc,EAEhC,OAAOA,CACT,CAEA,eAAsBG,EAASC,EAAgB,CAC7C,MAAMJ,EAAS,MAAMD,EAAA,EACfM,EAASX,EAAoB,MAAMU,CAAK,EAExCE,EAAO,MAAMC,EAAY,CAAE,GAAIF,EAAO,OAAQ,EAEpD,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,gBAAgB,EAGlC,GAAIA,EAAK,SAAWN,EAClB,MAAM,IAAI,MAAM,cAAc,EAGhC,OAAO,MAAMQ,EAAiB,CAAE,GAAIH,EAAO,OAAQ,CACrD,CAEA,eAAsBI,EAAYL,EAAgB,CAChD,MAAMJ,EAAS,MAAMD,EAAA,EACfM,EAASR,EAAuB,MAAMO,CAAK,EAE3CE,EAAO,MAAMC,EAAY,CAAE,GAAIF,EAAO,OAAQ,EAEpD,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,gBAAgB,EAGlC,GAAIA,EAAK,SAAWN,EAClB,MAAM,IAAI,MAAM,cAAc,EAGhC,aAAMU,EAAgB,CACpB,OAAQL,EAAO,OACf,UAAWA,EAAO,UAClB,KAAMA,EAAO,IAAA,CACd,EAEM,CAAE,QAAS,EAAA,CACpB"}