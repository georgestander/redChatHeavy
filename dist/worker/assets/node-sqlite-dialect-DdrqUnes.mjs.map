{"version":3,"file":"node-sqlite-dialect-DdrqUnes.mjs","sources":["../../../node_modules/.pnpm/better-auth@1.4.18_better-sqlite3@12.6.2_drizzle-kit@0.25.0_drizzle-orm@0.34.1_@cloudflare+wo_gnuc4skgho5hqg2jqlfi6hk52u/node_modules/better-auth/dist/adapters/kysely-adapter/node-sqlite-dialect.mjs"],"sourcesContent":["import { CompiledQuery, DEFAULT_MIGRATION_LOCK_TABLE, DEFAULT_MIGRATION_TABLE, DefaultQueryCompiler, sql } from \"kysely\";\n\n//#region src/adapters/kysely-adapter/node-sqlite-dialect.ts\nvar NodeSqliteAdapter = class {\n\tget supportsCreateIfNotExists() {\n\t\treturn true;\n\t}\n\tget supportsTransactionalDdl() {\n\t\treturn false;\n\t}\n\tget supportsReturning() {\n\t\treturn true;\n\t}\n\tasync acquireMigrationLock() {}\n\tasync releaseMigrationLock() {}\n\tget supportsOutput() {\n\t\treturn true;\n\t}\n};\nvar NodeSqliteDriver = class {\n\t#config;\n\t#connectionMutex = new ConnectionMutex();\n\t#db;\n\t#connection;\n\tconstructor(config) {\n\t\tthis.#config = { ...config };\n\t}\n\tasync init() {\n\t\tthis.#db = this.#config.database;\n\t\tthis.#connection = new NodeSqliteConnection(this.#db);\n\t\tif (this.#config.onCreateConnection) await this.#config.onCreateConnection(this.#connection);\n\t}\n\tasync acquireConnection() {\n\t\tawait this.#connectionMutex.lock();\n\t\treturn this.#connection;\n\t}\n\tasync beginTransaction(connection) {\n\t\tawait connection.executeQuery(CompiledQuery.raw(\"begin\"));\n\t}\n\tasync commitTransaction(connection) {\n\t\tawait connection.executeQuery(CompiledQuery.raw(\"commit\"));\n\t}\n\tasync rollbackTransaction(connection) {\n\t\tawait connection.executeQuery(CompiledQuery.raw(\"rollback\"));\n\t}\n\tasync releaseConnection() {\n\t\tthis.#connectionMutex.unlock();\n\t}\n\tasync destroy() {\n\t\tthis.#db?.close();\n\t}\n};\nvar NodeSqliteConnection = class {\n\t#db;\n\tconstructor(db) {\n\t\tthis.#db = db;\n\t}\n\texecuteQuery(compiledQuery) {\n\t\tconst { sql: sql$1, parameters } = compiledQuery;\n\t\tconst rows = this.#db.prepare(sql$1).all(...parameters);\n\t\treturn Promise.resolve({ rows });\n\t}\n\tasync *streamQuery() {\n\t\tthrow new Error(\"Streaming query is not supported by SQLite driver.\");\n\t}\n};\nvar ConnectionMutex = class {\n\t#promise;\n\t#resolve;\n\tasync lock() {\n\t\twhile (await this.#promise) await this.#promise;\n\t\tthis.#promise = new Promise((resolve) => {\n\t\t\tthis.#resolve = resolve;\n\t\t});\n\t}\n\tunlock() {\n\t\tconst resolve = this.#resolve;\n\t\tthis.#promise = void 0;\n\t\tthis.#resolve = void 0;\n\t\tresolve?.();\n\t}\n};\nvar NodeSqliteIntrospector = class {\n\t#db;\n\tconstructor(db) {\n\t\tthis.#db = db;\n\t}\n\tasync getSchemas() {\n\t\treturn [];\n\t}\n\tasync getTables(options = { withInternalKyselyTables: false }) {\n\t\tlet query = this.#db.selectFrom(\"sqlite_schema\").where(\"type\", \"=\", \"table\").where(\"name\", \"not like\", \"sqlite_%\").select(\"name\").$castTo();\n\t\tif (!options.withInternalKyselyTables) query = query.where(\"name\", \"!=\", DEFAULT_MIGRATION_TABLE).where(\"name\", \"!=\", DEFAULT_MIGRATION_LOCK_TABLE);\n\t\tconst tables = await query.execute();\n\t\treturn Promise.all(tables.map(({ name }) => this.#getTableMetadata(name)));\n\t}\n\tasync getMetadata(options) {\n\t\treturn { tables: await this.getTables(options) };\n\t}\n\tasync #getTableMetadata(table) {\n\t\tconst db = this.#db;\n\t\tconst autoIncrementCol = (await db.selectFrom(\"sqlite_master\").where(\"name\", \"=\", table).select(\"sql\").$castTo().execute())[0]?.sql?.split(/[\\(\\),]/)?.find((it) => it.toLowerCase().includes(\"autoincrement\"))?.split(/\\s+/)?.[0]?.replace(/[\"`]/g, \"\");\n\t\treturn {\n\t\t\tname: table,\n\t\t\tcolumns: (await db.selectFrom(sql`pragma_table_info(${table})`.as(\"table_info\")).select([\n\t\t\t\t\"name\",\n\t\t\t\t\"type\",\n\t\t\t\t\"notnull\",\n\t\t\t\t\"dflt_value\"\n\t\t\t]).execute()).map((col) => ({\n\t\t\t\tname: col.name,\n\t\t\t\tdataType: col.type,\n\t\t\t\tisNullable: !col.notnull,\n\t\t\t\tisAutoIncrementing: col.name === autoIncrementCol,\n\t\t\t\thasDefaultValue: col.dflt_value != null\n\t\t\t})),\n\t\t\tisView: true\n\t\t};\n\t}\n};\nvar NodeSqliteQueryCompiler = class extends DefaultQueryCompiler {\n\tgetCurrentParameterPlaceholder() {\n\t\treturn \"?\";\n\t}\n\tgetLeftIdentifierWrapper() {\n\t\treturn \"\\\"\";\n\t}\n\tgetRightIdentifierWrapper() {\n\t\treturn \"\\\"\";\n\t}\n\tgetAutoIncrement() {\n\t\treturn \"autoincrement\";\n\t}\n};\nvar NodeSqliteDialect = class {\n\t#config;\n\tconstructor(config) {\n\t\tthis.#config = { ...config };\n\t}\n\tcreateDriver() {\n\t\treturn new NodeSqliteDriver(this.#config);\n\t}\n\tcreateQueryCompiler() {\n\t\treturn new NodeSqliteQueryCompiler();\n\t}\n\tcreateAdapter() {\n\t\treturn new NodeSqliteAdapter();\n\t}\n\tcreateIntrospector(db) {\n\t\treturn new NodeSqliteIntrospector(db);\n\t}\n};\n\n//#endregion\nexport { NodeSqliteDialect };\n//# sourceMappingURL=node-sqlite-dialect.mjs.map"],"names":["NodeSqliteAdapter","NodeSqliteDriver","#config","#connectionMutex","ConnectionMutex","#db","#connection","config","NodeSqliteConnection","connection","CompiledQuery","db","compiledQuery","sql$1","parameters","rows","#promise","#resolve","resolve","NodeSqliteIntrospector","options","query","DEFAULT_MIGRATION_TABLE","DEFAULT_MIGRATION_LOCK_TABLE","tables","name","#getTableMetadata","table","autoIncrementCol","it","sql","col","NodeSqliteQueryCompiler","DefaultQueryCompiler","NodeSqliteDialect"],"mappings":"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","x_google_ignoreList":[0]}