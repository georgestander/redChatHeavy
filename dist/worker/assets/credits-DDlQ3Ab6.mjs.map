{"version":3,"file":"credits-DDlQ3Ab6.mjs","sources":["../../../lib/db/credits.ts","../../../src/server/actions/credits.ts"],"sourcesContent":["import \"server-only\";\nimport { eq, sql } from \"drizzle-orm\";\nimport { db } from \"./client\";\nimport { userCredit } from \"./schema\";\n\nasync function ensureUserCreditRow(userId: string) {\n  await db.insert(userCredit).values({ userId }).onConflictDoNothing();\n}\n\n/**\n * Get user's current credit balance (in cents).\n */\nexport async function getCredits(userId: string): Promise<number> {\n  let rows = await db\n    .select({ credits: userCredit.credits })\n    .from(userCredit)\n    .where(eq(userCredit.userId, userId))\n    .limit(1);\n\n  if (rows.length === 0) {\n    await ensureUserCreditRow(userId);\n    rows = await db\n      .select({ credits: userCredit.credits })\n      .from(userCredit)\n      .where(eq(userCredit.userId, userId))\n      .limit(1);\n  }\n\n  return rows[0]?.credits ?? 0;\n}\n\n/**\n * Check if user has positive credits (can spend).\n */\nexport async function canSpend(userId: string): Promise<boolean> {\n  const credits = await getCredits(userId);\n  return credits > 0;\n}\n\n/**\n * Deduct credits from user. Allows going slightly negative for in-progress operations.\n */\nexport async function deductCredits(\n  userId: string,\n  amount: number\n): Promise<void> {\n  await ensureUserCreditRow(userId);\n  await db\n    .update(userCredit)\n    .set({\n      credits: sql`${userCredit.credits} - ${amount}`,\n    })\n    .where(eq(userCredit.userId, userId));\n}\n\n/**\n * Add credits to user (for purchases, refunds, etc).\n */\nasync function _addCredits(userId: string, amount: number): Promise<void> {\n  await ensureUserCreditRow(userId);\n  await db\n    .update(userCredit)\n    .set({\n      credits: sql`${userCredit.credits} + ${amount}`,\n    })\n    .where(eq(userCredit.userId, userId));\n}\n","\"use server\";\n\nimport { requestInfo } from \"rwsdk/worker\";\nimport { auth } from \"@/lib/auth\";\nimport { getCredits } from \"@/lib/db/credits\";\n\nasync function requireUserId() {\n  const session = await auth.api.getSession({\n    headers: requestInfo.request.headers,\n  });\n  const userId = session?.user?.id;\n  if (!userId) {\n    throw new Error(\"UNAUTHORIZED\");\n  }\n  return userId;\n}\n\nexport async function getAvailableCredits() {\n  const userId = await requireUserId();\n  const credits = await getCredits(userId);\n  return { credits };\n}\n"],"names":["ensureUserCreditRow","userId","db","userCredit","getCredits","rows","eq","requireUserId","auth","requestInfo","getAvailableCredits"],"mappings":"unBAKA,eAAeA,EAAoBC,EAAgB,CACjD,MAAMC,EAAG,OAAOC,CAAU,EAAE,OAAO,CAAE,OAAAF,CAAA,CAAQ,EAAE,oBAAA,CACjD,CAKA,eAAsBG,EAAWH,EAAiC,CAChE,IAAII,EAAO,MAAMH,EACd,OAAO,CAAE,QAASC,EAAW,QAAS,EACtC,KAAKA,CAAU,EACf,MAAMG,EAAGH,EAAW,OAAQF,CAAM,CAAC,EACnC,MAAM,CAAC,EAEV,OAAII,EAAK,SAAW,IAClB,MAAML,EAAoBC,CAAM,EAChCI,EAAO,MAAMH,EACV,OAAO,CAAE,QAASC,EAAW,OAAA,CAAS,EACtC,KAAKA,CAAU,EACf,MAAMG,EAAGH,EAAW,OAAQF,CAAM,CAAC,EACnC,MAAM,CAAC,GAGLI,EAAK,CAAC,GAAG,SAAW,CAC7B,CCvBA,eAAeE,GAAgB,CAI7B,MAAMN,GAHU,MAAMO,EAAK,IAAI,WAAW,CACxC,QAASC,EAAY,QAAQ,OAAA,CAC9B,IACuB,MAAM,GAC9B,GAAI,CAACR,EACH,MAAM,IAAI,MAAM,cAAc,EAEhC,OAAOA,CACT,CAEA,eAAsBS,GAAsB,CAC1C,MAAMT,EAAS,MAAMM,EAAA,EAErB,MAAO,CAAE,QADO,MAAMH,EAAWH,CAAM,CAC9B,CACX"}